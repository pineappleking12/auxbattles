<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aux Battles - Game Lobby</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/game.css">
</head>
<body>
  <div class="container">
    <div class="main-content">
      <h1>Aux Battles - Game Lobby</h1>
      <div id="roomCodeDisplay">Room Code: <span id="roomCode"></span></div>
      <div id="players" class="ready-section">
        <h2>Players</h2>
        <!-- Players will be updated here -->
      </div>
      <button id="startGameBtn">Start Game</button>
      <button id="readyBtn">Ready Up</button>
      <button id="leaveBtn" onclick="leaveGame()">Leave Game</button>
    </div>

    <div class="chat">
      <h2>Chat</h2>
      <div id="messages"></div>
      <input type="text" id="chatInput" placeholder="Type a message...">
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const username = decodeURIComponent(urlParams.get('username'));
    const gameCode = window.location.pathname.slice(1);
    const isHost = urlParams.get('host') === 'true';

    // Update room code display
    document.getElementById('roomCode').innerText = gameCode;

    // Join the game
    socket.emit('joinGame', { gameCode, username, isHost });

    // Show the "Start Game" button only for the host
    if (isHost) {
      document.getElementById('startGameBtn').style.display = 'block';
      document.getElementById('readyBtn').style.display = 'none'; // Hide the ready button for the host
    } else {
      document.getElementById('startGameBtn').style.display = 'none'; // Hide the start button for non-hosts
    }

    // Handle the Ready button for non-hosts
    let isReady = false;
    document.getElementById('readyBtn').addEventListener('click', () => {
      isReady = !isReady; // Toggle ready state
      socket.emit('toggleReady', { gameCode, username, ready: isReady });
      document.getElementById('readyBtn').textContent = isReady ? 'Unready' : 'Ready Up'; // Change button text
    });

    // Start game with countdown when host clicks "Start Game"
    document.getElementById('startGameBtn').addEventListener('click', () => {
      socket.emit('startGame', { gameCode });

      let countdown = 3;
      const countdownInterval = setInterval(() => {
        if (countdown > 0) {
          socket.emit('sendMessage', { gameCode, message: `Game starts in ${countdown}...` });
          countdown--;
        } else {
          clearInterval(countdownInterval);
          socket.emit('sendMessage', { gameCode, message: 'Game started!' });
        }
      }, 1000);
    });

    // Handle chat input
    const chatInput = document.getElementById('chatInput');
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        socket.emit('sendMessage', { gameCode, message: `${username}: ${chatInput.value}` });
        chatInput.value = '';
      }
    });

    // Listen for messages and player updates
    socket.on('chatMessage', (message) => {
      const messages = document.getElementById('messages');
      const messageElement = document.createElement('div');
      messageElement.textContent = message;
      messages.appendChild(messageElement);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on('playerUpdate', (players) => {
      const playersDiv = document.getElementById('players');
      playersDiv.innerHTML = '<h2>Players</h2>';
      players.forEach(player => {
        const playerElement = document.createElement('div');
        playerElement.textContent = player.username + (player.ready ? ' (Ready)' : '');
        playersDiv.appendChild(playerElement);
      });
    });

    // Leave the game
    function leaveGame() {
      socket.emit('leaveGame', { gameCode, username });
      window.location.href = '/';
    }

    // Handle game start announcement
    socket.on('gameStarting', () => {
      // Additional logic when game starts (e.g., redirect)
    });
  </script>
</body>
</html>
