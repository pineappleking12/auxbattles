<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aux Battles - Game Lobby</title>
  <link rel="stylesheet" href="css/game.css">
</head>
<body>
  <div class="container">
    <h1>Game Lobby</h1>
    
    <div id="roomCodeDisplay">Room Code: <span id="roomCode"></span></div>
    
    <button id="leaveBtn">Leave</button>

    <!-- Chat section -->
    <div class="chat">
      <h2>Chat</h2>
      <div id="messages"></div>
      <input type="text" id="messageInput" placeholder="Type a message and press Enter">
    </div>



  <!-- Ready section -->
<div class="ready-section">
  <h2>Players</h2>
  <div id="players"></div>
  <label for="readyCheckbox">
    <input type="checkbox" id="readyCheckbox"> I'm Ready
  </label>
  
  <!-- Host-only "Start Game" button -->
  <button id="startGameBtn" style="display:none;">Start Game</button>
</div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const roomCode = window.location.pathname.split('/')[1];
    const username = localStorage.getItem('username') || prompt('Enter your username'); // prompt if no username is found

    localStorage.setItem('username', username); // save the username

    document.getElementById('roomCode').innerText = roomCode;

    // Join game logic
    socket.emit('joinGame', { gameCode: roomCode, username });

    // Handle chat messages
    document.getElementById('messageInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const message = event.target.value;
        if (message.trim() !== '') {
          socket.emit('sendMessage', { gameCode: roomCode, message: username + ": " + message });
          event.target.value = ''; // clear the input field
        }
      }
    });

    socket.on('chatMessage', (message) => {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += `<p>${message}</p>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto scroll to the latest message
    });

    // Handle ready state toggle
    document.getElementById('readyCheckbox').addEventListener('change', (e) => {
      const ready = e.target.checked;
      socket.emit('toggleReady', { gameCode: roomCode, username, ready });
    });

    // Update players list with ready state and host indication
    socket.on('playerUpdate', (players) => {
      const playersDiv = document.getElementById('players');
      playersDiv.innerHTML = '';
      players.forEach(player => {
        const playerDiv = document.createElement('div');
        playerDiv.innerText = `${player.username} ${player.ready ? '(Ready)' : '(Not Ready)'} ${player.isHost ? '(Host)' : ''}`;
        playersDiv.appendChild(playerDiv);
      });
    });

    // Leave game logic
    document.getElementById('leaveBtn').addEventListener('click', () => {
      socket.emit('leaveGame', { gameCode: roomCode, username });
      window.location.href = '/';
    });

    // Notify when a player leaves
    socket.on('playerLeft', (username) => {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += `<p>${username} has left the game.</p>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto scroll to the latest message
    });
  </script>
</body>
</html>
